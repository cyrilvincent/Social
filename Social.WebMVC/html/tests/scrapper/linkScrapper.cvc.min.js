jQuery.ajax = (function (_ajax) {
    var protocol = location.protocol,
        hostname = location.hostname,
        exRegex = RegExp(protocol + '//' + hostname),
        YQL = 'http' + (/^https/.test(protocol) ? 's' : '') + '://query.yahooapis.com/v1/public/yql?callback=?', query = 'select * from html where url="{URL}" and xpath="*"';

    function isExternal(url) {
        return !exRegex.test(url) && /:\/\//.test(url)
    }

    return function (o) {
        var url = o.url;
        if (/get/i.test(o.type) && !/json/i.test(o.dataType) && isExternal(url)) {
            o.url = YQL;
            o.dataType = 'json';
            o.data = {
                q: query.replace('{URL}', url + (o.data ? (/\?/.test(url) ? '&' : '?') + jQuery.param(o.data) : '')),
                format: 'xml'
            };
            if (!o.success && o.complete) {
                o.success = o.complete;
                delete o.complete
            }
            o.success = (function (_success) {
                return function (data) {
                    if (_success) {
                        _success.call(this, {
                            responseText: (data.results[0] || '').replace(/<script[^>]+?\/>|<script(.|\s)*?\/script>/gi, '')
                        }, 'success')
                    }
                }
            })(o.success)
        } return _ajax.apply(this, arguments)
    }
})(jQuery.ajax);

String.prototype.startsWith = function (str) {
    return (this.match("^" + str) == str)
};

$(document).ready(function () {
    var urlInUse = '';
    var imgSrcArray = [];
    var imgArrayCounter = 0;
    var tid;
    var setNewTimer = false;
    function applyCss() {
        var scrapper_post_button_css = {
            'background-color': 'rgb(164,15,9)',
            'border': 'none',
            'color': 'white',
            'padding-left': '7px',
            'padding-right': '7px',
            'padding-top': '3px',
            'padding-bottom': '3px'
        };
        var linkBox_css = { 'border': '1px solid #e2e2e2' };
        var scrapper_css = { 'border': '1px solid #e2e2e2' };
        var scrapper_img_css = {
            'background-position': 'center',
            'background-color': 'white',
            'background-repeat': 'no-repeat',
            'background-size': 'contain',
        };
        var scrapper_img_holder_css = { 'padding': '2px', 'margin': '2px' };
        var scrapper_img_count_css = { 'font-size': '10px', 'color': 'rgb(127,127,127)', 'text-align': 'center' };
        var scrapper_text_holder_css = { 'padding': '2px', 'margin': '2px' };
        var scrapper_title_css = { 'font-weight': 'bold', 'font-size': '14px' };
        var linkScrapper_css = { 'font': '12px Calibri' };
        var button_css = { 'border': '1px solid  rgba(0, 0, 0, 0.5)', 'cursor': 'hand', 'cursor': 'pointer' };
        $('#linkScrapper').css(linkScrapper_css);
        $('.linkBox').css(linkBox_css);
        $('#scrapper_img').css(scrapper_img_css);
        $('#scrapper').css(scrapper_css);
        $('#scrapper_img_holder').css(scrapper_img_holder_css);
        $('#scrapper_img_count').css(scrapper_img_count_css);
        $('#scrapper_text_holder').css(scrapper_text_holder_css);
        $('#scrapper_title').css(scrapper_title_css);
        $('#prevPicButton').css(button_css);
        $('#scrapper_post_button').css(button_css);
        $('#scrapper_post_button').css(scrapper_post_button_css);
        $('#nextPicButton').css(button_css);
        $('.linkBox').css('width', scrapper_total_width + 'px');
        $('#scrapper_img').css('width', scrapper_image_width + 'px');
        $('#scrapper_img').css('height', scrapper_image_height + 'px');
        $('#scrapper').css('width', (scrapper_total_width + 3) + 'px')
    }

    function scrapeURL(urlText) {
        if (urlText.indexOf('http://') >= 0) {
            urlString = getUrl('http://', urlText);
            getUrlData(urlString);
            $('#scrapper').show()
        }
        else if (urlText.indexOf('https://') >= 0) {
            urlString = getUrl('https://', urlText);
            getUrlData(urlString);
            $('#scrapper').show()
        }
        else if (urlText.indexOf('www.') >= 0) {
            urlString = getUrl('http://', 'http://' + urlText);
            getUrlData(urlString);
            $('#scrapper').show()
        }
        else { $('#scrapper').hide() }
    }

    function abortTimer() {
        if (null != tid) clearTimeout(tid)
    }

    var $scrapperHTML = $('<textarea id="linkBox" class="linkBox" rows="2" cols="30"></textarea><table id="scrapper"><tr><td><table id="scrapper_img_holder"><tr><td colspan="2" style="height:100px; overflow:hidden;"><div id="scrapper_img"></div></td></tr><tr><td id="" style="width:50%; text-align:right;"><input type="button" id="prevPicButton" value="<"></td><td id="" style="width:50%; text-align:left;"><input type="button" id="nextPicButton" value=">"></td></tr><tr><td colspan="2"><div id="scrapper_img_count"></div></td></tr></table></td><td><table id="scrapper_text_holder"><tr><td ><div id="scrapper_title"></div></td></tr><tr><td ><div id="scrapper_url"></div></td></tr><tr><td ><br/><div id="scrapper_description"></div></td></tr></table></td></tr></table><br/><input type="button" id="scrapper_post_button" value="Post">');
    $('#linkScrapper').append($scrapperHTML);
    $('#scrapper').hide();
    applyCss();

    $("#scrapper_post_button").click(function () {
        scrapperLinkURL = $('#scrapper_url').text();
        scrapperLinkTitle = $('#scrapper_title').text();
        scrapperLinkDescription = $('#scrapper_description').text();
        scrapperLinkImageURL = imgSrcArray[imgArrayCounter];
        scrapperText = $("#linkBox").val();
        displayScrapperData()
    });

    $("#nextPicButton").click(function () {
        imgArrayCounter++;
        if (imgArrayCounter >= imgSrcArray.length) imgArrayCounter = 0;
        $('#scrapper_img').css('backgroundImage', 'url(' + imgSrcArray[imgArrayCounter] + ')');
        $('#scrapper_img_count').text((imgArrayCounter + 1) + ' of ' + imgSrcArray.length)
    });

    $("#prevPicButton").click(function () {
        imgArrayCounter--;
        if (imgArrayCounter < 0) imgArrayCounter = imgSrcArray.length - 1;
        $('#scrapper_img').css('backgroundImage', 'url(' + imgSrcArray[imgArrayCounter] + ')');
        $('#scrapper_img_count').text((imgArrayCounter + 1) + ' of ' + imgSrcArray.length)
    });

    $(".linkBox").keyup(function (event) {
        urlText = this.value;
        abortTimer();
        tid = setTimeout(function () { scrapeURL(urlText) }, 2000);
        if (event.which == 13) { this.rows++ }
    });

    function getUrl(prefix, urlText) {
        var urlString = '';
        var startIndex = urlText.indexOf(prefix);
        for (var i = startIndex; i < urlText.length; i++) {
            if (urlText[i] == ' ' || urlText[i] == '\n') break;
            else urlString += urlText[i]
        }
        return urlString
    }

    function getUrlData(urlString) {
        if (urlInUse == urlString) return;
        $.ajax({
            url: urlString, type: 'GET',
            success: function (res) {
                urlInUse = urlString;
                var metaName;
                var metaContent;
                var imgSrc;
                $('#scrapper_description').text('');
                $('#scrapper_title').text('');
                $('#scrapper_url').text('');
                $('#scrapper_img').css('backgroundImage', '');
                imgSrcArray = [];
                imgArrayCounter = 0;
                var htmlString = res.responseText;
                var $htmlString = $(htmlString);
                var startIndex = htmlString.indexOf('<head>') + 6;
                var endIndex = htmlString.indexOf('</head>');
                var headerHTML = htmlString.substring(startIndex, endIndex);
                var $wrapper = $('<div />').html(headerHTML);
                var title = '';
                title = $("title", $wrapper).text();
                $('#scrapper_title').text(title);
                $('#scrapper_url').text(urlString);
                ($wrapper.find("meta")).each(
                    function (index, domElement) {
                        metaName = $(domElement).attr('name');
                        metaProperty = $(domElement).attr('property');
                        metaContent = $(domElement).attr('content');
                        if (metaName == 'description' || metaName == 'Description') {
                            $('#scrapper_description').text(metaContent)
                        }
                    });
                var nbIteration = 5;
                ($htmlString.find("img"))
                    .sort(
                        function (a, b) {
                            var widtha = $(a).attr('width');
                            var widthb = $(b).attr('width');
                            var heighta = $(a).attr('height');
                            var heightb = $(b).attr('height');
                            var srca = $(b).attr('src');
                            var srcb = $(b).attr('src');
                            if (widtha == null) widtha = 50;
                            if (widthb == null) widthb = 50;
                            if (heighta != null && heighta < 10) widtha = 0;
                            if (heightb != null && heightb < 10) widthb = 0;
                            if (srca != null && srca.indexOf('.gif') > -1) widtha = 0;
                            if (srcb != null && srcb.indexOf('.gif') > -1) widthb = 0;
                            return widthb - widtha;
                        }
                    )
                    .each(
                        function (index, domElement) {
                            if (nbIteration > 0) {
                                //imgSrc = $(domElement).data('thumb');
                                //if (imgSrc != null && imgSrc.length > 0)
                                // ne marche pas ce n'est pas le même type
                                    imgSrc = $(domElement).attr('src');
                                if (imgSrc != null && imgSrc.length > 0) {

                                    if (imgSrc.startsWith("//")) {
                                        imgSrc = "http:" + imgSrc
                                    }
                                    else if (imgSrc.startsWith("/")) {
                                        imgSrc = urlString + imgSrc
                                    }
                                    else imgSrc = urlString + "/" + imgSrc
                                    if (imgSrc.indexOf("pixel") == -1) {
                                        nbIteration--;
                                        imgSrcArray.push(imgSrc)
                                    }
                                }
                            }
                        }
                    );
                $('#scrapper_img').css('backgroundImage', 'url(' + imgSrcArray[imgArrayCounter] + ')');
                $('#scrapper_img_count').text('1 of ' + imgSrcArray.length)
            }
        })
    }
});